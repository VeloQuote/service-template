name: Promote to QA

on:
  workflow_dispatch:
    inputs:
      artifact_version:
        description: 'Artifact version to deploy (e.g., 84fb588-20250120-143022)'
        required: true
        type: string

jobs:
  promote:
    name: Deploy to QA
    runs-on: ubuntu-latest
    environment: qa

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate build tag exists
        run: |
          echo "ðŸ” Checking for build tag: build-${{ inputs.artifact_version }}"

          if ! git ls-remote --tags origin | grep -q "build-${{ inputs.artifact_version }}"; then
            echo "âŒ Error: Build tag 'build-${{ inputs.artifact_version }}' not found"
            echo ""
            echo "Available build tags:"
            git ls-remote --tags origin | grep "build-" | tail -n 10
            exit 1
          fi

          echo "âœ… Build tag found"

      - name: Extract service name
        id: service
        run: |
          FULL_SERVICE=$(grep "^service:" serverless.yml | awk '{print $2}')
          SERVICE_NAME=$(echo $FULL_SERVICE | sed 's/veloflow-//')
          echo "service_name=$SERVICE_NAME" >> $GITHUB_OUTPUT
          echo "full_service=$FULL_SERVICE" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Service: $SERVICE_NAME"

      - name: Get artifact run ID
        id: get_run
        run: |
          # Extract git SHA from version
          GIT_SHA=$(echo ${{ inputs.artifact_version }} | cut -d'-' -f1)

          # Get the workflow run that created this build tag
          RUN_ID=$(gh run list \
            --workflow=ci-deploy-dev.yml \
            --limit 50 \
            --json databaseId,headSha \
            --jq ".[] | select(.headSha | startswith(\"$GIT_SHA\")) | .databaseId" \
            | head -n 1)

          if [ -z "$RUN_ID" ]; then
            echo "âŒ Error: Could not find workflow run for artifact version ${{ inputs.artifact_version }}"
            exit 1
          fi

          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Found workflow run: $RUN_ID"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: service-${{ steps.service.outputs.service_name }}-${{ inputs.artifact_version }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.get_run.outputs.run_id }}

      - name: Extract artifact
        run: |
          tar -xzf service-${{ steps.service.outputs.service_name }}-${{ inputs.artifact_version }}.tar.gz
          echo "âœ… Artifact extracted (source code)"
          ls -la

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Serverless Framework
        run: npm install

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Package for QA
        run: |
          echo "ðŸ“¦ Packaging for QA stage..."
          npx serverless package --stage qa --verbose
          echo "âœ… Packaged for QA"
          ls -la .serverless/

      - name: Deploy to QA
        run: |
          echo "ðŸš€ Deploying to QA..."
          npx serverless deploy --stage qa --package .serverless --verbose
          echo "âœ… Deployed to QA"

      - name: Run smoke tests
        run: |
          echo "ðŸ§ª Running QA smoke test..."

          # Check if test-event.json exists
          if [ ! -f "test-event.json" ]; then
            echo "âš ï¸  test-event.json not found - skipping smoke test"
            echo "   Create test-event.json to enable smoke testing"
            exit 0
          fi

          # Update test-event.json to use QA buckets
          jq '.input_bucket = "veloflow-qa-input" | .output_bucket = "veloflow-qa-output"' test-event.json > test-event-qa.json 2>/dev/null || cp test-event.json test-event-qa.json
          echo "ðŸ“„ QA test event:"
          cat test-event-qa.json | jq '.' || cat test-event-qa.json

          # Extract bucket and key from test-event-qa.json
          INPUT_BUCKET=$(jq -r '.input_bucket // empty' test-event-qa.json)
          INPUT_KEY=$(jq -r '.input_key // empty' test-event-qa.json)

          # Check if test file exists in S3 before invoking
          if [ -n "$INPUT_BUCKET" ] && [ -n "$INPUT_KEY" ]; then
            if ! aws s3 ls "s3://$INPUT_BUCKET/$INPUT_KEY" >/dev/null 2>&1; then
              echo "âš ï¸  Test file not found in S3: s3://$INPUT_BUCKET/$INPUT_KEY"
              echo "   Upload a test file to enable smoke testing:"
              echo "   aws s3 cp your-test-file.ext s3://$INPUT_BUCKET/$INPUT_KEY"
              exit 0
            fi
            echo "âœ… Test file found in S3: s3://$INPUT_BUCKET/$INPUT_KEY"
          fi

          # Invoke Lambda with test event
          aws lambda invoke \
            --function-name ${{ steps.service.outputs.full_service }}-qa-processor \
            --payload file://test-event-qa.json \
            --cli-binary-format raw-in-base64-out \
            response.json

          # Display response
          echo "ðŸ“„ Lambda Response:"
          cat response.json | jq '.'

          # Check for errors
          if grep -q '"status": "error"' response.json; then
            echo "âŒ Smoke test FAILED - Lambda returned error status"
            exit 1
          fi

          if grep -q '"FunctionError"' response.json; then
            echo "âŒ Smoke test FAILED - Lambda execution error"
            exit 1
          fi

          echo "âœ… Smoke test PASSED"

      - name: Create QA tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "qa-${{ inputs.artifact_version }}"
          git push origin "qa-${{ inputs.artifact_version }}"
          echo "âœ… Created tag: qa-${{ inputs.artifact_version }}"

      - name: Deployment summary
        if: always()
        run: |
          echo "## ðŸŽ¯ QA Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** QA" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** ${{ steps.service.outputs.service_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ inputs.artifact_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Artifact:** service-${{ steps.service.outputs.service_name }}-${{ inputs.artifact_version }}.tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "**Function:** ${{ steps.service.outputs.full_service }}-qa-processor" >> $GITHUB_STEP_SUMMARY
          echo "**QA Tag:** qa-${{ inputs.artifact_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "After testing in QA, promote to Production:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "gh workflow run promote-prod.yml -f artifact_version=${{ inputs.artifact_version }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
